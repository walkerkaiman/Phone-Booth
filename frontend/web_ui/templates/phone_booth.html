<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phone Booth Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            height: 100vh;
            overflow: hidden;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 15px;
            height: 100vh;
            display: grid;
            grid-template-columns: 1fr 1fr;
            grid-template-rows: auto 1fr auto;
            gap: 15px;
            overflow: hidden;
        }

        .header {
            grid-column: 1 / -1;
            text-align: center;
            color: white;
            font-size: 2em;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            margin-bottom: 10px;
        }

        .control-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            gap: 15px;
            max-height: 100%;
            overflow-y: auto;
        }

        .status-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #007bff;
        }

        .status-section h3 {
            color: #007bff;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .status-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .status-item {
            background: white;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .status-label {
            font-weight: bold;
            color: #495057;
            font-size: 0.9em;
            margin-bottom: 5px;
        }

        .status-value {
            color: #212529;
            font-size: 1.1em;
        }

        .phone-controls {
            display: flex;
            gap: 15px;
            justify-content: center;
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            min-width: 140px;
        }

        .btn-primary {
            background: #007bff;
            color: white;
        }

        .btn-primary:hover {
            background: #0056b3;
            transform: translateY(-2px);
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        .btn-danger:hover {
            background: #c82333;
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .conversation-panel {
            background: white;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            display: flex;
            flex-direction: column;
            max-height: 100%;
        }

        .conversation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e9ecef;
        }

        .conversation-header h3 {
            color: #007bff;
            font-size: 1.3em;
        }

        .conversation-container {
            flex: 1;
            overflow-y: auto;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            padding: 15px;
            background: #f8f9fa;
            min-height: 200px;
            max-height: 300px;
        }

        .message {
            margin-bottom: 15px;
            padding: 12px;
            border-radius: 8px;
            max-width: 80%;
        }

        .message.user {
            background: #007bff;
            color: white;
            margin-left: auto;
        }

        .message.assistant {
            background: #e9ecef;
            color: #333;
            margin-right: auto;
        }

        .message-header {
            font-size: 0.8em;
            margin-bottom: 5px;
            opacity: 0.8;
        }

        .message-content {
            font-size: 0.95em;
            line-height: 1.4;
        }

        .message-meta {
            font-size: 0.75em;
            margin-top: 5px;
            opacity: 0.7;
        }

        .input-section {
            margin-top: 20px;
            display: flex;
            gap: 10px;
        }

        .input-section input {
            flex: 1;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 1em;
        }

        .input-section input:focus {
            outline: none;
            border-color: #007bff;
        }

        .input-section button {
            padding: 12px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            transition: background 0.3s ease;
        }

        .input-section button:hover {
            background: #218838;
        }

        .lighting-panel {
            grid-column: 1 / -1;
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            max-height: 80px;
        }

        .lighting-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .lighting-header h3 {
            color: #007bff;
            font-size: 1.2em;
        }

        .lighting-display {
            height: 40px;
            background: #000;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
        }

        .light {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            margin: 0 3px;
            transition: all 0.1s ease;
        }

        .light.off {
            background: #333;
        }

        .light.on {
            background: #ff6b6b;
            box-shadow: 0 0 10px #ff6b6b;
        }

        .current-mode {
            background: #e3f2fd;
            padding: 10px 15px;
            border-radius: 8px;
            border: 2px solid #bbdefb;
            font-weight: bold;
            color: #1976d2;
            text-align: center;
            margin-bottom: 15px;
        }

        .mode-icon {
            margin-right: 8px;
        }

        .settings-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 20px;
            border-left: 4px solid #6c757d;
        }

        .settings-section h3 {
            color: #6c757d;
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .settings-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .setting-item {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .setting-item label {
            font-weight: bold;
            color: #495057;
            font-size: 0.9em;
        }

        .settings-actions {
            margin-top: 20px;
            display: flex;
            gap: 10px;
            justify-content: center;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

        .btn-info {
            background: #17a2b8;
            color: white;
        }

        .btn-info:hover {
            background: #138496;
            transform: translateY(-2px);
        }

        .setting-item select {
            flex: 1;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .setting-item select:focus {
            outline: none;
            border-color: #007bff;
        }

        /* Modal styles for TTS settings */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal-content {
            background-color: #fefefe;
            margin: 5% auto;
            padding: 0;
            border-radius: 15px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.5em;
        }

        .close {
            color: white;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            opacity: 0.7;
        }

        .modal-body {
            padding: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: #495057;
            font-weight: 500;
        }

        .form-group select,
        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }

        .form-group select:focus,
        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #007bff;
        }

        @media (max-width: 768px) {
            .container {
                grid-template-columns: 1fr;
                grid-template-rows: auto auto 1fr auto;
            }
            
            .lighting-panel {
                grid-column: 1;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            üìû Phone Booth Dashboard
        </div>

        <div class="control-panel">
            <div class="status-section">
                <h3>üîß System Status</h3>
                <div class="status-grid">
                    <div class="status-item">
                        <div class="status-label">Backend Status</div>
                        <div class="status-value" id="backendStatus">Checking...</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">LLM Engine</div>
                        <div class="status-value" id="llmEngine">Unknown</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Current Model</div>
                        <div class="status-value" id="currentModel">Unknown</div>
                    </div>
                    <div class="status-item">
                        <div class="status-label">Session Status</div>
                        <div class="status-value" id="sessionStatus">Disconnected</div>
                    </div>
                </div>
            </div>

            <div class="current-mode" id="currentMode">
                <span class="mode-icon">üí¨</span>
                <span class="mode-label">Conversation</span>
            </div>

            <div class="phone-controls">
                <button class="btn btn-primary" id="pickupBtn" onclick="pickupPhone()">üìû Pick Up Phone</button>
                <button class="btn btn-danger" id="hangupBtn" onclick="hangupPhone()" disabled>üìû Hang Up Phone</button>
            </div>

            <div class="settings-section">
                <h3>‚öôÔ∏è Settings</h3>
                <div class="settings-grid">
                    <div class="setting-item">
                        <label for="personalitySelect">Character:</label>
                        <select id="personalitySelect" onchange="changePersonality()">
                            <option value="trickster">The Trickster</option>
                            <option value="sage">The Sage</option>
                            <option value="muse">The Muse</option>
                            <option value="jester">The Jester</option>
                            <option value="night_watch">The Night Watch</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="modelSelect">Model:</label>
                        <select id="modelSelect" onchange="switchModel()">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="inputDevice">Microphone:</label>
                        <select id="inputDevice">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label for="outputDevice">Speaker:</label>
                        <select id="outputDevice">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                </div>
                <div class="settings-actions">
                    <button class="btn btn-secondary" onclick="loadAudioDevices()">üîÑ Refresh Audio</button>
                    <button class="btn btn-secondary" onclick="loadModels()">üîÑ Refresh Models</button>
                    <button class="btn btn-info" onclick="openTTSSettings()">üé≠ Voice Settings</button>
                </div>
            </div>
        </div>

        <div class="conversation-panel">
            <div class="conversation-header">
                <h3>üí¨ Conversation</h3>
                <button onclick="clearConversation()" style="background: #6c757d; color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer;">Clear</button>
            </div>
            <div class="conversation-container" id="conversation">
                <div style="text-align: center; color: #6c757d; margin-top: 50px;">
                    Pick up the phone to start a conversation
                </div>
            </div>
            <div class="input-section">
                <input type="text" id="message" placeholder="Type your message..." onkeypress="handleKeyPress(event)">
                <button onclick="speak()">Send</button>
            </div>
        </div>

        <div class="lighting-panel">
            <div class="lighting-header">
                <h3>üí° Lighting System</h3>
                <div style="font-size: 0.9em; color: #6c757d;">Real-time audio visualization</div>
            </div>
            <div class="lighting-display" id="lightingDisplay">
                <div class="light off"></div>
                <div class="light off"></div>
                <div class="light off"></div>
                <div class="light off"></div>
                <div class="light off"></div>
                <div class="light off"></div>
                <div class="light off"></div>
                <div class="light off"></div>
            </div>
        </div>
    </div>

    <!-- TTS Settings Modal -->
    <div id="ttsSettingsModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üé≠ Voice Settings</h3>
                <span class="close" onclick="closeTTSSettings()">&times;</span>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label for="ttsPersonalitySelect">Select Personality:</label>
                    <select id="ttsPersonalitySelect" onchange="loadPersonalitySettings()">
                        <option value="trickster">The Trickster</option>
                        <option value="sage">The Sage</option>
                        <option value="muse">The Muse</option>
                        <option value="jester">The Jester</option>
                        <option value="night_watch">The Night Watch</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="speedPrompt">Speed Prompt:</label>
                    <select id="speedPrompt">
                        <option value="[speed_1]">Very Slow</option>
                        <option value="[speed_2]">Slow</option>
                        <option value="[speed_3]">Moderate-Slow</option>
                        <option value="[speed_4]">Moderate</option>
                        <option value="[speed_5]">Normal</option>
                        <option value="[speed_6]">Moderate-Fast</option>
                        <option value="[speed_7]">Fast</option>
                        <option value="[speed_8]">Very Fast</option>
                        <option value="[speed_9]">Extremely Fast</option>
                        <option value="[speed_10]">Maximum Speed</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="temperature">Temperature (Creativity): <span id="temperatureValue">0.3</span></label>
                    <input type="range" id="temperature" min="0.1" max="1.0" step="0.1" value="0.3" oninput="updateTemperatureValue()">
                </div>
                
                <div class="form-group">
                    <label for="topP">Top P (Diversity): <span id="topPValue">0.7</span></label>
                    <input type="range" id="topP" min="0.1" max="1.0" step="0.1" value="0.7" oninput="updateTopPValue()">
                </div>
                
                <div class="form-group">
                    <label for="repetitionPenalty">Repetition Penalty: <span id="repetitionPenaltyValue">1.05</span></label>
                    <input type="range" id="repetitionPenalty" min="1.0" max="1.2" step="0.01" value="1.05" oninput="updateRepetitionPenaltyValue()">
                </div>
                
                <div style="margin-top: 20px; text-align: center;">
                    <button class="btn btn-primary" onclick="saveTTSSettings()">üíæ Save Settings</button>
                    <button class="btn btn-secondary" onclick="resetTTSSettings()">üîÑ Reset to Default</button>
                    <button class="btn btn-info" onclick="testVoice()">üé§ Test Voice</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentSessionId = null;
        let isConnected = false;

        // Initialize dashboard
        document.addEventListener('DOMContentLoaded', function() {
            updateStatus();
            setInterval(updateStatus, 5000); // Update status every 5 seconds
            
            // Load initial settings
            loadAudioDevices();
            loadModels();
            loadPersonalitySettings();
        });

        // Update system status
        async function updateStatus() {
            try {
                // Check backend health using the status endpoint
                const statusResponse = await fetch('/api/status');
                const statusData = await statusResponse.json();
                document.getElementById('backendStatus').textContent = statusData.session_active ? 'Online' : 'Offline';
                document.getElementById('backendStatus').style.color = statusData.session_active ? '#28a745' : '#dc3545';

                // Get current model info
                const modelResponse = await fetch('/api/models/current');
                const modelData = await modelResponse.json();
                document.getElementById('llmEngine').textContent = modelData.engine_type || 'Unknown';
                document.getElementById('currentModel').textContent = modelData.current_model || 'Unknown';

                // Update session status
                document.getElementById('sessionStatus').textContent = statusData.session_active ? 'Connected' : 'Disconnected';
                document.getElementById('sessionStatus').style.color = statusData.session_active ? '#28a745' : '#6c757d';

            } catch (error) {
                console.error('Status update failed:', error);
                document.getElementById('backendStatus').textContent = 'Offline';
                document.getElementById('backendStatus').style.color = '#dc3545';
                document.getElementById('sessionStatus').textContent = 'Disconnected';
                document.getElementById('sessionStatus').style.color = '#6c757d';
            }
        }

        // Update current mode display
        function updateCurrentMode(modeName) {
            const modeDisplay = document.getElementById('currentMode');
            const modeIcons = {
                'conversation': 'üí¨',
                'questions': '‚ùì',
                'riddles': 'üß©',
                'compliments': 'üíù',
                'advice': 'üí°',
                'stories': 'üìñ',
                'fashion': 'üëó'
            };
            
            const modeLabels = {
                'conversation': 'Conversation',
                'questions': 'Questions',
                'riddles': 'Riddles',
                'compliments': 'Compliments',
                'advice': 'Advice',
                'stories': 'Stories',
                'fashion': 'Fashion'
            };

            const icon = modeIcons[modeName] || 'üí¨';
            const label = modeLabels[modeName] || 'Conversation';
            
            modeDisplay.innerHTML = `<span class="mode-icon">${icon}</span><span class="mode-label">${label}</span>`;
            
            // Add brief animation
            modeDisplay.style.transform = 'scale(1.05)';
            setTimeout(() => {
                modeDisplay.style.transform = 'scale(1)';
            }, 200);
        }

        // Pick up phone
        async function pickupPhone() {
            const personality = 'trickster';
            const mode = 'chat';
            
            try {
                const response = await fetch('/api/pickup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        personality: personality,
                        mode: mode
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    currentSessionId = data.session_id;
                    isConnected = true;
                    
                    // Update button states
                    document.getElementById('pickupBtn').disabled = true;
                    document.getElementById('hangupBtn').disabled = false;
                    
                    // Update status immediately
                    updateStatus();
                    loadConversation();
                } else {
                    showMessage(data.error, 'error');
                }
            } catch (error) {
                showMessage('Failed to pick up phone: ' + error.message, 'error');
            }
        }

        // Hang up phone
        async function hangupPhone() {
            try {
                const response = await fetch('/api/hangup', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(data.message, 'success');
                    currentSessionId = null;
                    isConnected = false;
                    
                    // Update button states
                    document.getElementById('pickupBtn').disabled = false;
                    document.getElementById('hangupBtn').disabled = true;
                    
                    // Update status immediately
                    updateStatus();
                    clearConversation();
                } else {
                    showMessage(data.error, 'error');
                }
            } catch (error) {
                showMessage('Failed to hang up phone: ' + error.message, 'error');
            }
        }

        // Speak
        async function speak() {
            const message = document.getElementById('message').value;
            const personality = document.getElementById('personalitySelect').value;
            const mode = document.getElementById('modelSelect').value;
            
            if (!message.trim()) {
                showMessage('Please enter a message', 'error');
                return;
            }
            
            // Add user message to conversation
            addMessage('You', message, 'user');
            
            try {
                const response = await fetch('/api/speak', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: message,
                        personality: personality,
                        mode: mode
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    
                    // Add AI response to conversation
                    addMessage(personality.charAt(0).toUpperCase() + personality.slice(1), data.response, 'assistant', data.processing_time, data.selected_mode);
                    
                    // Play audio if available
                    if (data.audio_url) {
                        const audio = new Audio(data.audio_url);
                        audio.play().catch(e => console.log('Audio playback failed:', e));
                    }
                    
                    // Animate lighting if amplitude envelope is provided
                    if (data.amplitude_envelope) {
                        animateLighting(data.amplitude_envelope);
                    }
                    
                    // Update current mode display if we have selected_mode
                    if (data.selected_mode) {
                        updateCurrentMode(data.selected_mode);
                    }
                    
                    // Clear input
                    document.getElementById('message').value = '';
                } else {
                    const errorData = await response.json();
                    addMessage('System', 'Error: ' + errorData.error, 'error');
                }
            } catch (error) {
                console.error('Error:', error);
                addMessage('System', 'Network error occurred', 'error');
            }
        }

        // Add message to conversation
        function addMessage(sender, content, type, processingTime = null, selectedMode = null) {
            const conversation = document.getElementById('conversation');
            
            // Clear the placeholder message if it exists
            if (conversation.children.length === 1 && conversation.children[0].style.textAlign === 'center') {
                conversation.innerHTML = '';
            }
            
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${type}`;
            
            let metaInfo = '';
            if (processingTime) {
                metaInfo += `Processing: ${processingTime.toFixed(2)}s`;
            }
            if (selectedMode && selectedMode !== 'conversation') {
                metaInfo += metaInfo ? ` | Mode: ${selectedMode}` : `Mode: ${selectedMode}`;
            }
            
            messageDiv.innerHTML = `
                <div class="message-header">${sender}</div>
                <div class="message-content">${content}</div>
                ${metaInfo ? `<div class="message-meta">${metaInfo}</div>` : ''}
            `;
            
            conversation.appendChild(messageDiv);
            conversation.scrollTop = conversation.scrollHeight;
        }

        // Clear conversation
        function clearConversation() {
            const conversation = document.getElementById('conversation');
            conversation.innerHTML = '<div style="text-align: center; color: #6c757d; margin-top: 50px;">Pick up the phone to start a conversation</div>';
        }

        // Load conversation (placeholder for future implementation)
        function loadConversation() {
            // This could load previous conversation history if needed
        }

        // Handle Enter key in input
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                speak();
            }
        }

        // Show message (toast notification)
        function showMessage(message, type) {
            // Simple console logging for now - could be enhanced with toast notifications
            console.log(`${type.toUpperCase()}: ${message}`);
        }

        // Animate lighting based on audio amplitude
        function animateLighting(amplitudeEnvelope) {
            if (!amplitudeEnvelope || !Array.isArray(amplitudeEnvelope)) {
                return;
            }

            const lights = document.querySelectorAll('.light');
            const numLights = lights.length;
            
            // Map amplitude values to lights
            amplitudeEnvelope.forEach((amplitude, index) => {
                const lightIndex = Math.floor((index / amplitudeEnvelope.length) * numLights);
                if (lightIndex < numLights) {
                    const light = lights[lightIndex];
                    const intensity = Math.min(amplitude, 1);
                    
                    if (intensity > 0.3) {
                        light.className = 'light on';
                        light.style.opacity = intensity;
                    } else {
                        light.className = 'light off';
                        light.style.opacity = 1;
                    }
                }
            });

            // Reset lights after animation
            setTimeout(() => {
                lights.forEach(light => {
                    light.className = 'light off';
                    light.style.opacity = 1;
                });
            }, 1000);
        }

        // Stop lighting animation
        function stopLightAnimation() {
            const lights = document.querySelectorAll('.light');
            lights.forEach(light => {
                light.className = 'light off';
                light.style.opacity = 1;
            });
        }

        // Character/Personality Management
        async function changePersonality() {
            const personality = document.getElementById('personalitySelect').value;
            console.log(`Character changed to: ${personality}`);
            // This would update the current session personality if active
            if (isConnected) {
                showMessage(`Character changed to ${personality}. Changes will apply to new conversations.`, 'info');
            }
        }

        // Model Management
        async function loadModels() {
            try {
                const response = await fetch('/api/models');
                const data = await response.json();
                
                const modelSelect = document.getElementById('modelSelect');
                modelSelect.innerHTML = '';
                
                if (data.models && data.models.length > 0) {
                    data.models.forEach(model => {
                        const option = document.createElement('option');
                        option.value = model;
                        option.textContent = model;
                        if (model === data.current_model) {
                            option.selected = true;
                        }
                        modelSelect.appendChild(option);
                    });
                } else {
                    const option = document.createElement('option');
                    option.value = '';
                    option.textContent = 'No models available';
                    modelSelect.appendChild(option);
                }
            } catch (error) {
                console.error('Failed to load models:', error);
                const modelSelect = document.getElementById('modelSelect');
                modelSelect.innerHTML = '<option value="">Failed to load models</option>';
            }
        }

        async function switchModel() {
            const modelSelect = document.getElementById('modelSelect');
            const selectedModel = modelSelect.value;
            
            if (!selectedModel) {
                return;
            }
            
            try {
                showMessage(`Switching to model: ${selectedModel}...`, 'info');
                
                const response = await fetch('/api/models/switch', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        model_name: selectedModel
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage(`Successfully switched to ${selectedModel}`, 'success');
                    updateStatus(); // Refresh status to show new model
                } else {
                    showMessage(`Failed to switch model: ${data.error}`, 'error');
                }
                
            } catch (error) {
                console.error('Failed to switch model:', error);
                showMessage('Failed to switch model: ' + error.message, 'error');
            }
        }

        // Audio Device Management
        async function loadAudioDevices() {
            try {
                const response = await fetch('/api/audio/devices');
                const data = await response.json();
                
                if (data.error) {
                    showMessage('Failed to load audio devices: ' + data.error, 'error');
                    return;
                }
                
                // Populate input devices
                const inputSelect = document.getElementById('inputDevice');
                inputSelect.innerHTML = '<option value="">Default System Microphone</option>';
                
                if (data.input_devices) {
                    data.input_devices.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device.index;
                        option.textContent = `[${device.index}] ${device.name}`;
                        if (device.index === data.default_input) {
                            option.textContent += ' (Default)';
                        }
                        inputSelect.appendChild(option);
                    });
                }
                
                // Populate output devices
                const outputSelect = document.getElementById('outputDevice');
                outputSelect.innerHTML = '<option value="">Default System Speaker</option>';
                
                if (data.output_devices) {
                    data.output_devices.forEach(device => {
                        const option = document.createElement('option');
                        option.value = device.index;
                        option.textContent = `[${device.index}] ${device.name}`;
                        if (device.index === data.default_output) {
                            option.textContent += ' (Default)';
                        }
                        outputSelect.appendChild(option);
                    });
                }
                
                // Load current configuration
                loadCurrentAudioConfig();
                
            } catch (error) {
                console.error('Failed to load audio devices:', error);
                showMessage('Failed to load audio devices', 'error');
            }
        }

        async function loadCurrentAudioConfig() {
            try {
                const response = await fetch('/api/audio/config');
                const config = await response.json();
                
                if (config.error) {
                    console.warn('Failed to load audio config:', config.error);
                    return;
                }
                
                // Set current values
                if (config.input_device !== null && config.input_device !== undefined) {
                    document.getElementById('inputDevice').value = config.input_device;
                }
                if (config.output_device !== null && config.output_device !== undefined) {
                    document.getElementById('outputDevice').value = config.output_device;
                }
                
            } catch (error) {
                console.error('Failed to load audio config:', error);
            }
        }

        // TTS Settings Management
        function openTTSSettings() {
            document.getElementById('ttsSettingsModal').style.display = 'block';
            loadPersonalitySettings();
        }

        function closeTTSSettings() {
            document.getElementById('ttsSettingsModal').style.display = 'none';
        }

        async function loadPersonalitySettings() {
            try {
                const personality = document.getElementById('ttsPersonalitySelect').value;
                const response = await fetch(`/api/tts/settings/${personality}`);
                const data = await response.json();
                
                if (data.success) {
                    const settings = data.settings;
                    
                    // Update form values
                    document.getElementById('speedPrompt').value = settings.prompt || '[speed_5]';
                    document.getElementById('temperature').value = settings.temperature || 0.3;
                    document.getElementById('topP').value = settings.top_P || 0.7;
                    document.getElementById('repetitionPenalty').value = settings.repetition_penalty || 1.05;
                    
                    // Update display values
                    updateTemperatureValue();
                    updateTopPValue();
                    updateRepetitionPenaltyValue();
                }
            } catch (error) {
                console.error('Failed to load personality settings:', error);
                showMessage('Failed to load voice settings', 'error');
            }
        }

        function updateTemperatureValue() {
            const value = document.getElementById('temperature').value;
            document.getElementById('temperatureValue').textContent = value;
        }

        function updateTopPValue() {
            const value = document.getElementById('topP').value;
            document.getElementById('topPValue').textContent = value;
        }

        function updateRepetitionPenaltyValue() {
            const value = document.getElementById('repetitionPenalty').value;
            document.getElementById('repetitionPenaltyValue').textContent = value;
        }

        async function saveTTSSettings() {
            try {
                const personality = document.getElementById('ttsPersonalitySelect').value;
                const settings = {
                    prompt: document.getElementById('speedPrompt').value,
                    temperature: parseFloat(document.getElementById('temperature').value),
                    top_P: parseFloat(document.getElementById('topP').value),
                    repetition_penalty: parseFloat(document.getElementById('repetitionPenalty').value)
                };
                
                const response = await fetch(`/api/tts/settings/${personality}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(settings)
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(result.message, 'success');
                } else {
                    showMessage('Failed to save settings: ' + result.error, 'error');
                }
                
            } catch (error) {
                console.error('Failed to save TTS settings:', error);
                showMessage('Failed to save voice settings', 'error');
            }
        }

        function resetTTSSettings() {
            // Reset to default values
            document.getElementById('speedPrompt').value = '[speed_5]';
            document.getElementById('temperature').value = 0.3;
            document.getElementById('topP').value = 0.7;
            document.getElementById('repetitionPenalty').value = 1.05;
            
            updateTemperatureValue();
            updateTopPValue();
            updateRepetitionPenaltyValue();
            
            showMessage('Settings reset to default values', 'info');
        }

        async function testVoice() {
            try {
                const personality = document.getElementById('ttsPersonalitySelect').value;
                const testMessage = "Hello! This is a test of the voice settings for this personality.";
                
                showMessage('Testing voice...', 'info');
                
                const response = await fetch('/api/speak', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        message: testMessage,
                        personality: personality,
                        mode: 'chat'
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showMessage('Voice test completed! Check the conversation for the result.', 'success');
                    
                    // Add test message to conversation
                    addMessage('You', 'Voice Test', 'user');
                    addMessage('Assistant', data.response, 'assistant', data.processing_time, data.selected_mode);
                    
                    // Animate lighting
                    animateLighting(data.amplitude_envelope);
                } else {
                    showMessage('Voice test failed: ' + data.error, 'error');
                }
                
            } catch (error) {
                console.error('Failed to test voice:', error);
                showMessage('Failed to test voice', 'error');
            }
        }
    </script>
</body>
</html>
